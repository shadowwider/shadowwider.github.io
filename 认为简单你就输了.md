# 认为简单你就输了

日前接到一个任务,让我把PDF的表格识别出来自动转化为excel的标准数据。因为类似的需求之前调研过，当初采用的方法是OCR识别图片，结果就是错误率不能接受。因为我们处理的是钱的问题，任何的错误都是不能接受的，所以这条线只能作罢了。这次的数据好在是规范的可复制文字的pdf文件，我想只要有工具可以把里面的文本复制出来放到对应的表格列中就好了，这个肯定是没问题的。 所以当初问这个工作需要多久，我就大胆的评估一天，就差说一句“不用试了，肯定可以的”。也就得亏当初没太自大才避免了后面被狠狠的打脸。

工作最开始很顺利，找一个工具很容易就把文件中的文本都抽取出来了，但是在想把这些文字结构化填写到对应表列的时候就发现了大麻烦。因为拿到的pdf文件在人的视角上看，表格是非常规范的，前面一个空是属性，后面紧跟的就是对应的值。所以想当然就以为工具读取的文本也是应该按照这个顺序出来，把对应属性后面的文字提取出来就好了。可惜的是pdf文件在原始信息上就不是这么存储的。我理解它大概是以画图的方式去展示这个文件，有点像html。文件中肉眼可以见的表格框在原始信息中，都会记录它的四个角的坐标，然后文字呢其实也是一个文本框，有四个坐标以及文字的内容，和ppt的文本框一样的。然后文件在展示的时候只要有这些信息，自然就可以把所有文本框 放到表格框内部然后拼接起来变成一个整体了。问题就出现在这里，因为这种模式所以pdf在文字信息在解析出来的文字里，其实完全不需要有对应的顺序，一个属性的值并不是一定要放在这个属性行的后面出现。它可以任意安排顺序，反正只要坐标有了总可以填写到对应的框中，以图形的坐标来拼到一起。这样就完全打乱了我根据文本出现的顺序来判断属性值的方案。好吧，那我只能尝试转换方式，你画我也画，我把每个框的坐标找出来然后再判断哪个文本框在哪个表格框内部，这样总可以了吧，结果又发现更奇葩的事情。有的空看起来明明是2个，然后每个格子里面一段文字，绝大多数情况也确实是这么记录的，但是就有那么一个格子，它有2个框，但是文本框却是一个，中间用空格隔开，类似“交易类型  现金”。直接看文件是“交易类型”在第一个框里，“现金”在紧接着的下一个框里。但是元数据解读出来就是文字在一起通过空格分到两个框内。非常不符合逻辑，想了很久也没想明白。当然如果只是一个空是这样我特殊处理一下总可以解析，但是这个例子揭示了一个问题就是pdf的原始信息有它自己独特的一套结构，并不和表面看上去那么一一对应的，如果不能像画图一样把它的信息全部使用起来，很难去把需要的信息正确的提取出来。

另外还有一个很有意思的业务上的困难。处理的pdf文件是银行的电子回单，那最重要的信息就是交易双方以及交易金额。但是电子回单的数据是交易金额永远都是正数，也没有文字说明是收入还是支出。那么怎么判断一笔交易究竟是收到款还是支出款呢，就只有通过表格最上方的左右两列，左边的一列永远是支出方，右边的一列永远是收入方。可惜这是人去看的情况，如果是用代码去解读，前面已经说了我无法仅根据文本知道哪个在左边哪个在右边，也就不可能知道谁是收款谁是付款，从而不知道这笔钱究竟是正还是负……

一个原本光听需求觉得分分钟搞定的东西，没想到坑有这么多。究其原因其实主要在于对PDF技术的无知吧。后来查阅了不少相关资料发现pdf的很多底层技术都是收费的，非公开的。一个excel文件怎么转换成pdf文件，并且保证矢量缩放、格式固定，相关信息在pdf的raw数据中是怎么记录的完全不了解。这次事情真是充分向自己证明了什么叫做无知无畏，分工协作发展到今天，复杂性已经远远超越个体人脑的理解范围了，以后的通才只会是越来越少了，世界一定要和平啊！